@page "/CourseManage/{Text?}"
@using Microsoft.EntityFrameworkCore
@using global::OJBlazor.Share.DataModels
@using System.ComponentModel.DataAnnotations
@using System.Globalization
@inject IDbContextFactory<OJContext> DbFactory
@inject NavigationManager navigation
@inject MessageService MessageService
@inject DialogService DialogService

@if (string.IsNullOrEmpty(Text))
{
    <Row ItemsPerRow="ItemsPerRow.Three" ColSpan="4">
        <Button Color="Color.None" IsAsync="true" OnClick="@(() => CourseModelDialog(null))">
            <Card IsCenter="true" IsShadow="true" class="item">
                <BodyTemplate>
                    <i class="fa-solid fa-plus 4x content"></i>
                </BodyTemplate>
            </Card>
        </Button>

        @foreach (var item in CourseModels)
        {
            <Button Color="Color.None" IsAsync="true" OnClick="@(() => CourseModelDialog(item))">
                <ContextMenuZone>
                    <ContextMenuTrigger>
                        <Card IsCenter="true" IsShadow="true" class="item">
                            <BodyTemplate>
                                <h6>@item.Name</h6>
                                <p>@item.Intro</p>
                            </BodyTemplate>
                        </Card>
                    </ContextMenuTrigger>
                    <ContextMenu>
                        <ContextMenuItem Icon="fa-solid fa-trash" Text="删除" OnClick="@(async (_, _) => await Remove(item))"/>
                        <ContextMenuItem Icon="fa-solid fa-pen-to-square" Text="编辑子内容" OnClick="@((_, _) => EditChildren(item))"/>
                    </ContextMenu>
                </ContextMenuZone>
            </Button>
        }
    </Row>
}
else
{
    if (!IsEditing)
    {
        <Row ItemsPerRow="ItemsPerRow.Three" ColSpan="4">
            <Button Color="Color.None" OnClick="@(() => { IsEditing = true; FormModel = new DialogTestModel(); })">
                <Card IsCenter="true" IsShadow="true" class="item">
                    <BodyTemplate>
                        <i class="fa-solid fa-plus 4x content"></i>
                    </BodyTemplate>
                </Card>
            </Button>
            @foreach (var item in TestModels)
            {
                <Card IsCenter="true" IsShadow="true" class="item">
                    <BodyTemplate>
                        <h6>@item.Name</h6>
                        <p>@item.Intro</p>
                    </BodyTemplate>
                </Card>
            }
        </Row>
    }
    else
    {
        <ValidateForm OnValidSubmit="OnTestSubmit" Model="@FormModel">
            <FloatingLabel PlaceHolder="Name" DisplayText="测试名称" @bind-Value="@FormModel.Name" TValue="string"/>
            <Divider/>
            <br/>
            <h4>简介:</h4>
            <Markdown Language="@CultureInfo.CurrentUICulture.Name" @bind-Html="@FormModel.Intro"/>
            <Divider/>
            <br/>
            <h4>测试参数:</h4>
            <Row ColSpan="4" ItemsPerRow="ItemsPerRow.Four">
                <FloatingLabel PlaceHolder="Name" DisplayText="类型" @bind-Value="@ArgRecord.Type" TValue="string"/>
                <FloatingLabel PlaceHolder="Name" DisplayText="变量名称" @bind-Value="@ArgRecord.Name" TValue="string"/>
                <FloatingLabel PlaceHolder="Name" DisplayText="变量值" @bind-Value="@ArgRecord.Value" TValue="string"/>
                <Button OnClick="@AddArg">添加</Button>
            </Row>
            <ListGroup TItem="ArgRecord" Items="@FormModel.Arg" GetItemDisplayText="@(x => x.ToString())"/>
            <Divider/>
            <br/>
            <h4>代码:</h4>
            <div class="row form-inline g-3">
                <div class="col-12 col-sm-6">
                    <Select TValue="string" OnSelectedItemChanged="@(item => { FormModel.Language = item.Value; return Task.CompletedTask; })" ShowLabel="true" DisplayText="Language">
                        <Options>
                            <SelectOption Text="JavaScript" Value="javascript"></SelectOption>
                            <SelectOption Text="CSharp" Value="csharp"></SelectOption>
                            <SelectOption Text="Razor" Value="razor"></SelectOption>
                            <SelectOption Text="Json" Value="json"></SelectOption>
                        </Options>
                    </Select>
                </div>
                <div class="col-12">
                    <CodeEditor Theme="vs" Value="@FormModel.Code" Language="@FormModel.Language"/>
                </div>
            </div>
            <Divider/>
            <br/>
            <Button ButtonType="ButtonType.Submit">完成</Button>
        </ValidateForm>
    }
}

@code {
    [Parameter] public string? Text { get; set; }

    private List<CourseModel> CourseModels { get; set; } = new();
    private List<TestModel> TestModels { get; set; } = new();
    private bool IsEditing { get; set; }
    private DialogTestModel FormModel { get; set; } = new();
    private ArgRecord ArgRecord { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await using var context = await DbFactory.CreateDbContextAsync();
        if (string.IsNullOrEmpty(Text))
        {
            CourseModels = await context.CourseModels.ToListAsync();
        }
        else
        {
            var c = await context.CourseModels.Include(x => x.Tests).FirstOrDefaultAsync(x => x.HashName == Text);
            if (c == null)
            {
                await MessageService.Show(new MessageOption() { Content = "没有内容，正在为您跳回" });
                navigation.NavigateTo("", true);
                return;
            }

            TestModels = c.Tests;
        }
    }

    #region CourseModel

    private Task EditChildren(CourseModel model)
    {
        navigation.NavigateTo($"CourseManage/{model.HashName}", true);
        return Task.CompletedTask;
    }

    private async Task Remove(CourseModel model)
    {
        await using var dbContextAsync = await DbFactory.CreateDbContextAsync();
        dbContextAsync.Remove(model);
        await dbContextAsync.SaveChangesAsync();
    }

    private async Task CourseModelDialog(CourseModel? model)
    {
        var m = new DialogCourseModel();
        if (model != null)
        {
            m.Intro = model.Intro;
            m.Name = model.Name;
            m.HashName = model.HashName;
        }

        var items = Utility.GenerateEditorItems<DialogCourseModel>();

        var option = new EditDialogOption<DialogCourseModel>()
        {
            Title = "课程",
            Model = m,
            Items = items,
            ItemsPerRow = 1,
            RowType = RowType.Inline,
            OnEditAsync = async context =>
            {
                if (context.Model is not DialogCourseModel courseModel) return false;
                if (string.IsNullOrEmpty(courseModel.Intro) || string.IsNullOrEmpty(courseModel.Name)) return false;
                await using var dbContextAsync = await DbFactory.CreateDbContextAsync();
                if (string.IsNullOrEmpty(courseModel.HashName))
                {
                    var c = new CourseModel()
                        { HashName = courseModel.ToString().GetHash(), Name = courseModel.Name, Intro = courseModel.Intro };
                    dbContextAsync.CourseModels.Add(c);
                    CourseModels.Add(c);
                }
                else
                {
                    var result = await dbContextAsync.CourseModels.FirstOrDefaultAsync(x => x.HashName == courseModel.HashName);
                    if (result == null) return true;
                    result.Name = courseModel.Name;
                    result.Intro = courseModel.Intro;
                    model!.Name = courseModel.Name;
                    model.Intro = courseModel.Intro;
                }

                await dbContextAsync.SaveChangesAsync();
                StateHasChanged();
                return true;
            }
        };

        await DialogService.ShowEditDialog(option);
    }

    public class DialogCourseModel
    {
        [AutoGenerateColumn(Ignore = true)] public string HashName { get; set; } = "";

        [Required(ErrorMessage = "{0}不能为空")]
        [AutoGenerateColumn(Order = 10, Filterable = true, Searchable = true)]
        [Display(Name = "课程名称")]
        public string Name { get; set; } = "";

        [Display(Name = "简介")]
        [Required]
        [AutoGenerateColumn(Order = 40, Sortable = true)]
        public string Intro { get; set; } = "";
    }

    #endregion

    public class DialogTestModel
    {
        public string Name { get; set; } = "";
        public string Intro { get; set; } = "";
        public List<ArgRecord> Arg { get; set; } = new();
        public string Code { get; set; } = "";
        public string Language { get; set; } = "";
    }

    private async Task OnTestSubmit(EditContext arg)
    {
        await using var context = await DbFactory.CreateDbContextAsync();
    }

    private void AddArg()
    {
        if (string.IsNullOrEmpty(ArgRecord.Type) || string.IsNullOrEmpty(ArgRecord.Name)) return;
        FormModel.Arg.Add(ArgRecord);
    }

}